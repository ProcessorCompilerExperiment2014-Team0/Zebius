# アセンブラ

## 基本的な文法
* INSTRUCTION ::= (LABEL) MNEMONIC ARGUMENTS
    * LABEL : アルファベットまたは'.'、'_'から始まり、それらと数字からなる文字列
        * ニーモニックと重複してはいけない
        * なくてもよい。また、命令と別の行でも同じ行でもよい。
        * 1つの命令に複数のラベルを付けられる
    * MNEMONIC : ニーモニック。規定の文字列
    * ARGUMENTS : 引数。','によって区切られる
        * 個々の引数
            * Rn : レジスタ直接
            * @Rn : レジスタ間接
            * FRn : 浮動小数レジスタ
            * #immd : 即値
                * immdは十進数のほか、H'xxxxの形の十六進数に対応(桁は任意)
            * @(disp*,PC) : ディスプレースメント付きPC相対
                * dispは十進数
            * PR : プロシージャレジスタ
            * FPUL : 浮動小数点コミュニケーションレジスタ
            * LABEL : ラベル。上記のラベルを参照する
                ディスプレースメントや即値に利用可能
                * MOV.L label,R0
                * BRA label
                * .data.l label (ラベル位置のPCになる) など

* 擬似命令
    * .align
        * 命令を4バイト境界に合わせる
        * 必要な場合、NOP(AND R0,R0)を挿入する
        * 即値の直前に入れればよい
    * .data.l
        * 4バイト即値を命令上に積む
        * 上記と同様の十進数か十六進数('#'つき)、またはラベルを引数として記述
            * マニュアルでは'#'はないので注意

* コメント
    * ';'から行末まで

* 大文字と小文字は区別される

## 使用方法

```
omake
./zasm <filename> <options>
```

### 入力
* アセンブリファイル(*.s)をコマンドライン引数として指定します

### 出力
* 入力ファイルの拡張子を除いたファイルに機械語を出力します
    * ただし現在はファイル名の末尾2文字を削るという超絶雑実装です
    * いずれはオプションで指定できるようにしたい
* また、同時に標準出力に解析結果を出力します
    * こちらもいずれオプションで指定できるようにしたい

### オプション
* -v
  * VHDL用のフォーマットで標準出力に書き出す
  * `n => x"XXXXXXXX", `の形で4バイトずつ
* -s <n>
  * 命令の開始位置を**4nバイト**ずらす
  * ずらす単位については一考の余地あり

### エラー処理
* 引数に存在しないラベルが与えられた際にエラーを吐きます
* ラベルが重複した際にエラーを吐きます
* 命令のフォーマットが合わない時にエラーを吐きます
    * 引数が過剰な場合や形式が合わない場合など
* 即値が表現できる範囲を超えた場合にエラーを吐きます
    * 十進数の場合は符号の有無を区別
    * ラベルによるディスプレースメントも十進数と同様
    * 十六進数の場合は命令の形式によらず符号無しとして扱う
    * 32bit即値については現在チェックを行なっていません
